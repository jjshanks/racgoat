# Markdown Output Contract

**Feature**: End-to-End Workflow & Markdown Output
**Contract Type**: Output Format Specification
**Version**: 1.0.0
**Date**: 2025-10-02

---

## Purpose

This contract defines the exact Markdown format for review output files generated by RacGoat. Contract tests verify that serialization produces valid, spec-compliant Markdown.

---

## Output Format Specification

### File Structure

```markdown
# Code Review

**Branch**: {branch_name}
**Commit**: {commit_sha}

## File: {file_path}

### Line {line_number}
{comment_text}

### Lines {start_line}-{end_line}
{comment_text}

### File-level comment
{comment_text}
```

### Grammar (EBNF-style)

```
document       = header file_section*
header         = h1_title NEWLINE metadata NEWLINE
h1_title       = "# Code Review"
metadata       = branch_line NEWLINE commit_line
branch_line    = "**Branch**: " branch_name
commit_line    = "**Commit**: " commit_sha

file_section   = file_header NEWLINE comment+
file_header    = "## File: " file_path
comment        = comment_header NEWLINE comment_body NEWLINE
comment_header = line_comment | range_comment | file_comment
line_comment   = "### Line " line_number
range_comment  = "### Lines " line_number "-" line_number
file_comment   = "### File-level comment"
comment_body   = TEXT

branch_name    = TEXT | "Unknown Branch"
commit_sha     = HEX_STRING | "Unknown SHA"
file_path      = POSIX_PATH
line_number    = POSITIVE_INTEGER
```

---

## Field Specifications

### Header Section

| Field | Type | Constraints | Example |
|-------|------|-------------|---------|
| Title | H1 heading | Exact text "# Code Review" | `# Code Review` |
| Branch | Bold metadata | Prefix "**Branch**: " + branch name | `**Branch**: main` |
| Commit | Bold metadata | Prefix "**Commit**: " + SHA (full or short) | `**Commit**: a1b2c3d4e5f6...` |

**Validation Rules**:
- Title must be exact match (case-sensitive)
- Branch/Commit use bold syntax (`**key**: value`)
- Branch defaults to "Unknown Branch" when git unavailable
- Commit defaults to "Unknown SHA" when git unavailable

### File Section

| Field | Type | Constraints | Example |
|-------|------|-------------|---------|
| File header | H2 heading | Prefix "## File: " + relative path | `## File: src/main.py` |
| File path | String | POSIX-style (forward slashes) | `racgoat/services/output.py` |

**Validation Rules**:
- File paths sorted alphabetically (predictable output)
- Paths relative to repository root
- Forward slashes even on Windows (cross-platform consistency)

### Comment Section

#### Line Comment

| Field | Type | Constraints | Example |
|-------|------|-------------|---------|
| Header | H3 heading | Format "### Line {N}" | `### Line 42` |
| Line number | Integer | Positive, 1-indexed | `42` |
| Body | Markdown text | User input, no escaping | `This needs error handling` |

#### Range Comment

| Field | Type | Constraints | Example |
|-------|------|-------------|---------|
| Header | H3 heading | Format "### Lines {N}-{M}" | `### Lines 50-55` |
| Start line | Integer | Positive, 1-indexed | `50` |
| End line | Integer | >= start line | `55` |
| Body | Markdown text | User input, no escaping | `Refactor this block` |

#### File-level Comment

| Field | Type | Constraints | Example |
|-------|------|-------------|---------|
| Header | H3 heading | Exact text "### File-level comment" | `### File-level comment` |
| Body | Markdown text | User input, no escaping | `Overall: well structured` |

**Validation Rules**:
- Comments within each file ordered by addition time (preserves review flow)
- Comment text preserved exactly (Markdown chars not escaped per FR-010a)
- Empty comment body not allowed (validation at creation)

---

## Contract Test Scenarios

### 1. Minimal Valid Output (Single Line Comment)

**Input**:
- Branch: "main"
- Commit: "abc123"
- File: "test.py"
- Comment: LineComment(text="Fix this", line_number=10)

**Expected Output**:
```markdown
# Code Review

**Branch**: main
**Commit**: abc123

## File: test.py

### Line 10
Fix this
```

### 2. Multiple Comment Types

**Input**:
- File: "app.py"
- Comments:
  - LineComment(text="Add validation", line_number=5)
  - RangeComment(text="Refactor loop", start_line=10, end_line=15)
  - FileComment(text="Good structure")

**Expected Output**:
```markdown
# Code Review

**Branch**: main
**Commit**: abc123

## File: app.py

### Line 5
Add validation

### Lines 10-15
Refactor loop

### File-level comment
Good structure
```

### 3. Special Markdown Characters Preserved

**Input**:
- Comment: LineComment(text="Use `*args` and `**kwargs`", line_number=20)

**Expected Output**:
```markdown
### Line 20
Use `*args` and `**kwargs`
```

**Validation**: Asterisks and backticks rendered as-is (no escaping)

### 4. Git Metadata Unavailable

**Input**:
- Git extraction fails (subprocess error)

**Expected Output**:
```markdown
# Code Review

**Branch**: Unknown Branch
**Commit**: Unknown SHA

...
```

### 5. Multiple Files (Alphabetical Order)

**Input**:
- Files: "zebra.py", "alpha.py", "beta.py"

**Expected Output**:
```markdown
## File: alpha.py
...

## File: beta.py
...

## File: zebra.py
...
```

### 6. Empty Session (No Comments)

**Input**:
- ReviewSession with `has_comments == False`

**Expected Output**:
- No file created (per FR-004)

**Validation**: File path does not exist after serialization

---

## Error Conditions

### Invalid Output Scenarios (Should Not Occur)

| Scenario | Detection | Handling |
|----------|-----------|----------|
| Empty comment text | Validation at creation | Reject comment (ValueError) |
| Invalid line number (<= 0) | Validation at creation | Reject comment (ValueError) |
| Invalid range (end < start) | Validation at creation | Reject comment (ValueError) |
| Missing git metadata fields | Serialization check | Use placeholders ("Unknown Branch", "Unknown SHA") |

---

## Contract Test Implementation

### Test File: `tests/contract/test_markdown_output.py`

**Test Structure**:
```python
def test_minimal_valid_output():
    """Raccoon stashes a single treasure (line comment)"""
    # Arrange: Create ReviewSession with one comment
    # Act: Serialize to Markdown
    # Assert: Exact match to expected format

def test_multiple_comment_types():
    """Goat climbs through all comment terrains"""
    # Test line, range, file comments in one file

def test_special_chars_preserved():
    """Raccoon respects shiny Markdown symbols"""
    # Verify no escaping of *, #, [, etc.

def test_git_metadata_placeholders():
    """Goat shrugs when git repo vanishes"""
    # Mock git failure, verify placeholders

def test_alphabetical_file_order():
    """Raccoon alphabetizes the trash pile"""
    # Multi-file session, verify sort order

def test_no_output_when_empty():
    """Goat refuses to leave droppings without reason"""
    # Empty session, verify no file created
```

**Assertion Helpers**:
- `assert_markdown_structure(output: str)` - Verify headings, metadata format
- `assert_comment_preserved(output: str, comment: Comment)` - Verify text exactly matches
- `assert_no_file_created(path: Path)` - Verify file does not exist

---

## Compliance Verification

### Automated Checks

1. **Structure Validation**: Parse output with Markdown parser, verify heading hierarchy
2. **Content Preservation**: Round-trip test (serialize → parse → compare to input)
3. **Format Consistency**: All contract tests produce valid CommonMark
4. **Edge Case Coverage**: All 6 contract scenarios must pass

### Manual Review Checklist

- [ ] Output renders correctly in GitHub
- [ ] Output renders correctly in VSCode preview
- [ ] Output renders correctly in `mdcat` or `glow` CLI tools
- [ ] File paths clickable in terminal (if supported)

---

## Versioning

**Contract Version**: 1.0.0

**Breaking Changes** (increment major):
- Change heading levels (H1/H2/H3)
- Change metadata format (bold syntax)
- Change comment header format

**Non-Breaking Changes** (increment minor):
- Add optional metadata fields
- Extend comment types

---

## References

- Feature Spec: `specs/004-end-to-end/spec.md` (FR-007, FR-008, FR-010a, FR-011)
- Data Model: `specs/004-end-to-end/data-model.md`
- CommonMark Spec: https://commonmark.org/

---

**Status**: Contract Defined ✅
**Next**: Implement contract tests (must fail before implementation)
